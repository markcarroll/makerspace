---
layout: post
title: klipper notes
date: 2021-08-26 21:47
author: Mark
tags: [3D_Printing, klipper]
summary:
image: /3dprinting/images/klipper/klipper.jpg
---

{% include toc.html %}

## Klipper Tips

### Config Files

#### Ender 6

My current Ender 6 <a href="files/klipper/ender6_printer.cfg">printer.cfg <i class='fa fa-download'></i></a>

### Bed leveling

#### Cacluate Bed Mesh

Run the following commands:

1. `BED_MESH_CALIBRATE`
2. `BED_MESH_PROFILE SAVE=name`
3. `SAVE_CONFIG`

Only run #2 and #3 above if you want the mesh to persist after reboot.

#### Bed Visualizer

To see bed mesh in Octoprint's Bed Visualizer, go to the `Bed Visualizer` page and click on the cog in the lower right. In the gcode box put:

```gcode
M140 S65                    ; set bed temp to 65C
G28                         ; home the axis while the bed is heating
M190 S65                    ; (optional) wait for the bed to get up to temperature
BED_MESH_CALIBRATE          ; start calibration
@BEDLEVELVISUALIZER         ; tell Octoprint plugin to listen to result
BED_MESH_OUTPUT PGP=0       ; report the mesh to Octoprint
BED_MESH_PROFILE SAVE=mesh  ; save the profile to named profile `mesh`
```

I also added a shortcut button on the bed visualizer page to save the config.

1. While still in the Bed Visualizer settings page click on `Commands` tab.
2. Create a new button, name it "Save Config"
3. Set the gcode to `SAVE_CONFIG`
4. Close the input dialog

Now save the settings page.

## Raspberry Pi Commands

### Installing Klipper

To initially install klipper on Raspberry Pi:

```sh
git clone https://github.com/KevinOConnor/klipper
./klipper/scripts/install-octopi.sh
```

To fetch the forked version of klipper that works with T5UID display on Ender 6:

```sh
git remote add desuuuuklipper https://github.com/Desuuuu/klipper.git
git fetch desuuuuklipper
git checkout desuuuuklipper/master
```

### Build the firmware for the motherboard

To compile the micro-controller code, start by running these commands on the Raspberry Pi:

```sh
cd ~/klipper/
make menuconfig
```

For the _BigTreeTech SKR 2_ in an _Ender 6_ set these as follows:

```txt
[*] Enable extra low-level configuration options
    Micro-controller Architecture (STMicroelectronics STM32)  --->
    Processor model (STM32F407)  --->
    Bootloader offset (32KiB bootloader)  --->
    Clock Reference (8 MHz crystal)  --->
    Communication interface (USB (on PA11/PA12))  --->
[*] Enable DGUS T5UID1 screen
        Screen Serial Port (USART1)  --->
    USB ids  --->
[ ] Specify a custom step pulse duration
()  GPIO pins to set at micro-controller startup
```

Now build the firmware file:

```sh
make
```

Now copy the `out/klipper.bin` file to the SD card on your computer. Best way to do this is from your Mac:

```sh
scp pi@octopi.local:/home/pi/klipper/out/klipper.bin /Volumes/SD\ FAT\ 4GB/firmware.bin
```

Then eject the SD Card with

```sh
diskutil eject
```

### Service control

To start, stop or restart klipper service on the Raspberry Pi command line:

```sh
sudo service klipper start|stop|restart
```
